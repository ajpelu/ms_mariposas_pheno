---
title: "climate sensibility"
author: '[Antonio J. Pérez-Luque](https://github.com/ajpelu) <a href="https://orcid.org/0000-0002-1747-0469" target="orcid.widget">
<img alt="ORCID logo" src="https://info.orcid.org/wp-content/uploads/2019/11/orcid_16x16.png" width="16" height="16" /></a>'
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(vroom)
library(glue)
library(glmulti)
library(lme4)
library(broom)
library(broom.mixed)
library(kableExtra)
library(DT)
library(qpcR)
```

```{r setup, echo=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10, fig.height = 7
)
```


```{r}
df_doy_wmd <- vroom::vroom(here::here("data/doy_peak_sps_WMD.csv"))
transectos <- vroom::vroom(here::here("data/transectos_metadata.csv"))

climate_data <- vroom::vroom(here::here("data/transectos_climate.csv")) |> 
  filter(hydro_year !=2007) |> 
  rename(site_id = transectid, year = hydro_year)
```


```{r, eval=FALSE, echo=FALSE, message=FALSE}
# Código antiguo antes del cambio de peak doy por WMD 
df_doy <- vroom::vroom(here::here("data/doy_peak_sps.csv"))

transectos <- vroom::vroom(here::here("data/transectos_metadata.csv"))
selected_sps <- vroom::vroom(here::here("data/selected_species.csv"))

climate_data <- vroom::vroom(here::here("data/transectos_climate.csv")) |> 
  filter(hydro_year !=2007) |> 
  rename(site_id = transectid, year = hydro_year)
```

## Prepare data 
```{r}
# aux_df <- df_doy |> 
#   filter(species %in% selected_sps$sp) |> 
#   dplyr::select(species, year, doy, site_id) 

aux_df <- df_doy_wmd |> 
   # filter(species %in% selected_sps$sp) |> 
   dplyr::select(species, year, doy = weigth_mean_date, site_id) 

df_tmean <- aux_df |> 
  left_join(
    (climate_data |> filter(var == "tmed")))

df_prec <- aux_df |> 
  inner_join(
    (climate_data |> filter(var == "p")))
```


# Models

- For each species, we model the relationship between the flight's peak doy and the temperature (and precipitation) variables. 
- We built 36 models using a time-window approach. We calculated the mean temperatures (and cumulative precipitation) of 36 potential time-windows ranging from one to three months from October of the previous year to September of the current year.
- We used these potential time-windows to identify the period of the year with the highest temperature (or precipitation) effect on the phenology of each species (the critical period). 
- For each time-window and species, we fitted the DOY using a model with temperature (or precipitation) as a predictor. Two types of model were used: for those species with more than 1 site, we fitted a GLMM model with site as a random effect and a Gaussian error distribution; and for species with only a site, we fitted a GLM with Gaussian error distribution. 
- For each species, we selected the best-fit model according to the AIC. 
- We compute the models with two approach: scaled a non-scaled. The first one were computed to get the slopes and compare the sensibility to temperature and precipitation. 


```{r, echo=FALSE}
# En el bucle para algunas species hay un problema de overparametrization
# Aquí https://pbgworks.org/sites/pbgworks.org/files/CHANGES_to_lme4_V2.0.pdf he visto una solución

# options(lmerControl=list(check.nobs.vs.rankZ = "warning",
#  check.nobs.vs.nlev = "warning",
#  check.nobs.vs.nRE = "warning",
#  check.nlev.gtreq.5 = "warning",
#  check.nlev.gtr.1 = "warning"))

```


## Temperature med 
### Scaled models 
```{r}
fit_glmm <- function(df, x) {
  glmm <- lme4::glmer(scale(doy) ~ scale(x) + (1 | site_id), 
                family = gaussian, 
                data = df)
  return(glmm)
}


fit_glm <- function(df, x) { 
  glm <- glm(scale(doy) ~ scale(x), 
                family = gaussian, 
                data = df)
  return(glm)
  }

sps <- unique(df_doy_wmd$species)

models_tmed<- data.frame()

# Tmed 
for (i in sps) {
  df <-
    df_doy_wmd |>
    filter(species == i) |>
    # dplyr::select(species, year, doy, site_id) |>
    dplyr::select(species, year, doy = weigth_mean_date, site_id) |>
    left_join(climate_data |> filter(var == "tmed"))


  nsites <- length(unique(df$site_id))

  if (nsites <= 1) {
    models <- df |>
      dplyr::select(Jan:Dec_preJanFeb) |>
      map(~ fit_glm(df, .x))

    # get AIC
    models_aic <- map(models, broom::glance) |>
      bind_rows(.id = "Model")
    
    # get R2
    models_r <- map2_dfr(
      names(models), models,
      ~ data.frame(Model = .x, r2 = MuMIn::r.squaredLR(.y))
    )
    
    # get COEF
    models_coef <- map(models, ~ broom::tidy(.x, conf.level = 0.95)) |>
      bind_rows(.id = "Model") |>
      rename(p_value = p.value)

    output_models <- models_coef |>
      full_join(models_aic, multiple = "all") |>
      full_join(models_r, multiple = "all") |>
      arrange(AIC) |>
      mutate(species = i, 
             model_type = "no mixed",
             nsites = nsites) |>
      relocate(species, nsites, model_type) 

    models_tmed <- bind_rows(models_tmed, output_models)
    
  } else {
    # if (nrow(df) > 5) {

    models <- df |>
      dplyr::select(Jan:Dec_preJanFeb) |>
      map(~ fit_glmm(df, .x))

    # get AIC
    models_aic <- map(models, broom.mixed::glance) |>
      bind_rows(.id = "Model")

    # get R2
    models_r <- map2_dfr(
      names(models), models,
      ~ data.frame(Model = .x, r2 = MuMIn::r.squaredGLMM(.y))
    )

    # get COEF
    models_coef <- map(models, ~ broom.mixed::tidy(.x,
      effects = c("fixed"),
      conf.level = 0.95
    )) |>
      bind_rows(.id = "Model") |>
      mutate(p_value = round(2 * (1 - pnorm(abs(statistic))), 4)) # add p.value of coef

    output_models <- models_coef |>
      full_join(models_aic, multiple = "all") |>
      full_join(models_r, multiple = "all") |>
      arrange(AIC) |>
      mutate(species = i, 
             model_type = "mixed",
             nsites = nsites) |>
      relocate(species, nsites, model_type) 

    models_tmed <- bind_rows(models_tmed, output_models)
  }
}

```

#### How many species 
```{r}
length(unique(models_tmed$species))
```


```{r}
models_tmed |>
  mutate(across(c(estimate, std.error, statistic, sigma, logLik, AIC, BIC, REMLcrit), ~round(., digits = 3))) |> 
  mutate(across(c(r2.R2m, r2.R2c, r2), ~round(., digits = 3))) |> 
  mutate(across(c(p_value), ~round(., digits = 4))) |> 
  DT::datatable()
```

```{r}
write_csv(models_tmed, "data/models_tmed_scaled.csv")
writexl::write_xlsx(models_tmed, "data/models_tmed_scaled.xlsx")
```


### Non-scaled models 
```{r}
fit_glmm <- function(df, x) {
  glmm <- lme4::glmer(doy ~ x + (1 | site_id), 
                family = gaussian, 
                data = df)
  return(glmm)
}

fit_glm <- function(df, x) { 
  glm <- glm(doy ~ scale(x), 
                family = gaussian, 
                data = df)
  return(glm)
  }

sps <- unique(df_doy_wmd$species)

models_tmed<- data.frame()

# Tmed 
for (i in sps) { 
  df <-
    df_doy_wmd |>
    filter(species == i) |>
    dplyr::select(species, year, doy = weigth_mean_date, site_id) |>
    left_join(climate_data |> filter(var == "tmed"))
  
  nsites <- length(unique(df$site_id))

  if (nsites <= 1) {
    models <- df |>
      dplyr::select(Jan:Dec_preJanFeb) |>
      map(~ fit_glm(df, .x))

    # get AIC
    models_aic <- map(models, broom::glance) |>
      bind_rows(.id = "Model")
    
    # get R2
    models_r <- map2_dfr(
      names(models), models,
      ~ data.frame(Model = .x, r2 = MuMIn::r.squaredLR(.y))
    )
    
    # get COEF
    models_coef <- map(models, ~ broom::tidy(.x, conf.level = 0.95)) |>
      bind_rows(.id = "Model") |>
      rename(p_value = p.value)

    output_models <- models_coef |>
      full_join(models_aic, multiple = "all") |>
      full_join(models_r, multiple = "all") |>
      arrange(AIC) |>
      mutate(species = i, 
             model_type = "no mixed",
             nsites = nsites) |>
      relocate(species, nsites, model_type) 

    models_tmed <- bind_rows(models_tmed, output_models)
    
  } else { 
    models <- df |>
      dplyr::select(Jan:Dec_preJanFeb) |>
      map(~ fit_glmm(df, .x))

    # get AIC
    models_aic <- map(models, broom.mixed::glance) |>
      bind_rows(.id = "Model")

    # get R2
    models_r <- map2_dfr(
      names(models), models,
      ~ data.frame(Model = .x, r2 = MuMIn::r.squaredGLMM(.y))
    )

    # get COEF
    models_coef <- map(models, ~ broom.mixed::tidy(.x,
      effects = c("fixed"),
      conf.level = 0.95
    )) |>
      bind_rows(.id = "Model") |>
      mutate(p_value = round(2 * (1 - pnorm(abs(statistic))), 4)) # add p.value of coef

    output_models <- models_coef |>
      full_join(models_aic, multiple = "all") |>
      full_join(models_r, multiple = "all") |>
      arrange(AIC) |>
      mutate(species = i, 
             model_type = "mixed",
             nsites = nsites) |>
      relocate(species, nsites, model_type) 

    models_tmed <- bind_rows(models_tmed, output_models)
    }
}

```

#### How many species 
```{r}
length(unique(models_tmed$species))
```


```{r}
models_tmed |>
  mutate(across(c(estimate, std.error, statistic, sigma, logLik, AIC, BIC, REMLcrit), ~round(., digits = 3))) |> 
  mutate(across(c(r2.R2m, r2.R2c, r2), ~round(., digits = 3))) |> 
  mutate(across(c(p_value), ~round(., digits = 4))) |> 
  DT::datatable()
```

```{r}
write_csv(models_tmed, "data/models_tmed.csv")
writexl::write_xlsx(models_tmed, "data/models_tmed.xlsx")
```



## Precip
### Scaled models 
```{r}
fit_glmm <- function(df, x) {
  glmm <- lme4::glmer(scale(doy) ~ scale(x) + (1 | site_id), 
                family = gaussian, 
                data = df)
  return(glmm)
}

fit_glm <- function(df, x) { 
  glm <- glm(scale(doy) ~ scale(x), 
                family = gaussian, 
                data = df)
  return(glm)
  }

sps <- unique(df_doy_wmd$species)

models_prec <- data.frame()

# Prec 
for (i in sps) { 
  df <-
    df_doy_wmd |>
    filter(species == i) |>
    dplyr::select(species, year, doy = weigth_mean_date, site_id) |>
    left_join(climate_data |> filter(var == "p"))
  
  nsites <- length(unique(df$site_id))

  if (nsites <= 1) { 
    models <- df |>
      dplyr::select(Jan:Dec_preJanFeb) |>
      map(~ fit_glm(df, .x))

    # get AIC
    models_aic <- map(models, broom::glance) |>
      bind_rows(.id = "Model")
    
    # get R2
    models_r <- map2_dfr(
      names(models), models,
      ~ data.frame(Model = .x, r2 = MuMIn::r.squaredLR(.y))
    )
    
    # get COEF
    models_coef <- map(models, ~ broom::tidy(.x, conf.level = 0.95)) |>
      bind_rows(.id = "Model") |>
      rename(p_value = p.value)

    output_models <- models_coef |>
      full_join(models_aic, multiple = "all") |>
      full_join(models_r, multiple = "all") |>
      arrange(AIC) |>
      mutate(species = i, 
             model_type = "no mixed",
             nsites = nsites) |>
      relocate(species, nsites, model_type) 

    models_prec <- bind_rows(models_prec, output_models)
    
  } else {

  models <- df |>
      dplyr::select(Jan:Dec_preJanFeb) |>
      map(~ fit_glmm(df, .x))

    # get AIC
    models_aic <- map(models, broom.mixed::glance) |>
      bind_rows(.id = "Model")

    # get R2
    models_r <- map2_dfr(
      names(models), models,
      ~ data.frame(Model = .x, r2 = MuMIn::r.squaredGLMM(.y))
    )

    # get COEF
    models_coef <- map(models, ~ broom.mixed::tidy(.x,
      effects = c("fixed"),
      conf.level = 0.95
    )) |>
      bind_rows(.id = "Model") |>
      mutate(p_value = round(2 * (1 - pnorm(abs(statistic))), 4)) # add p.value of coef

    output_models <- models_coef |>
      full_join(models_aic, multiple = "all") |>
      full_join(models_r, multiple = "all") |>
      arrange(AIC) |>
      mutate(species = i, 
             model_type = "mixed",
             nsites = nsites) |>
      relocate(species, nsites, model_type) 
  
  models_prec <- bind_rows(models_prec, output_models)
     
  }
}
```

#### How many species 
```{r}
length(unique(models_prec$species))
```


```{r}
models_prec |>
  mutate(across(c(estimate, std.error, statistic, sigma, logLik, AIC, BIC, REMLcrit), ~round(., digits = 3))) |> 
  mutate(across(c(r2.R2m, r2.R2c, r2), ~round(., digits = 3))) |> 
  mutate(across(c(p_value), ~round(., digits = 4))) |> 
  DT::datatable()
```

```{r}
write_csv(models_prec, "data/models_prec_scaled.csv")
writexl::write_xlsx(models_prec, "data/models_prec_scaled.xlsx")
```


### Non-scaled models 
```{r}
fit_glmm <- function(df, x) {
  glmm <- lme4::glmer(doy ~ scale(x) + (1 | site_id), 
                family = gaussian, 
                data = df)
  return(glmm)
}

fit_glm <- function(df, x) { 
  glm <- glm(doy ~ scale(x), 
                family = gaussian, 
                data = df)
  return(glm)
  }

sps <- unique(df_doy_wmd$species)

models_prec <- data.frame()

# Prec 
for (i in sps) { 
  df <-
    df_doy_wmd |>
    filter(species == i) |>
    dplyr::select(species, year, doy = weigth_mean_date, site_id) |>
    left_join(climate_data |> filter(var == "p"))
  
  nsites <- length(unique(df$site_id))

  if (nsites <= 1) { 
    models <- df |>
      dplyr::select(Jan:Dec_preJanFeb) |>
      map(~ fit_glm(df, .x))

    # get AIC
    models_aic <- map(models, broom::glance) |>
      bind_rows(.id = "Model")
    
    # get R2
    models_r <- map2_dfr(
      names(models), models,
      ~ data.frame(Model = .x, r2 = MuMIn::r.squaredLR(.y))
    )
    
    # get COEF
    models_coef <- map(models, ~ broom::tidy(.x, conf.level = 0.95)) |>
      bind_rows(.id = "Model") |>
      rename(p_value = p.value)

    output_models <- models_coef |>
      full_join(models_aic, multiple = "all") |>
      full_join(models_r, multiple = "all") |>
      arrange(AIC) |>
      mutate(species = i, 
             model_type = "no mixed",
             nsites = nsites) |>
      relocate(species, nsites, model_type) 

    models_prec <- bind_rows(models_prec, output_models)
    
  } else {

  models <- df |>
      dplyr::select(Jan:Dec_preJanFeb) |>
      map(~ fit_glmm(df, .x))

    # get AIC
    models_aic <- map(models, broom.mixed::glance) |>
      bind_rows(.id = "Model")

    # get R2
    models_r <- map2_dfr(
      names(models), models,
      ~ data.frame(Model = .x, r2 = MuMIn::r.squaredGLMM(.y))
    )

    # get COEF
    models_coef <- map(models, ~ broom.mixed::tidy(.x,
      effects = c("fixed"),
      conf.level = 0.95
    )) |>
      bind_rows(.id = "Model") |>
      mutate(p_value = round(2 * (1 - pnorm(abs(statistic))), 4)) # add p.value of coef

    output_models <- models_coef |>
      full_join(models_aic, multiple = "all") |>
      full_join(models_r, multiple = "all") |>
      arrange(AIC) |>
      mutate(species = i, 
             model_type = "mixed",
             nsites = nsites) |>
      relocate(species, nsites, model_type) 
  
  models_prec <- bind_rows(models_prec, output_models)
     
  }
}
```

#### How many species 
```{r}
length(unique(models_prec$species))
```


```{r}
models_prec |>
  mutate(across(c(estimate, std.error, statistic, sigma, logLik, AIC, BIC, REMLcrit), ~round(., digits = 3))) |> 
  mutate(across(c(r2.R2m, r2.R2c, r2), ~round(., digits = 3))) |> 
  mutate(across(c(p_value), ~round(., digits = 4))) |> 
  DT::datatable()
```

```{r}
write_csv(models_prec, "data/models_prec.csv")
writexl::write_xlsx(models_prec, "data/models_prec.xlsx")
```

# Select best models for each species 

```{r}
best_models_temp <- models_tmed |> 
  group_by(species) |> 
  filter(term == "x") |> 
  dplyr::select(species, Model, AIC) |> 
  mutate(deltaAIC = akaike.weights(AIC)$deltaAIC, 
         w = akaike.weights(AIC)$weights) |> 
  filter(deltaAIC <= 4)

write_csv(best_models_temp, "data/best_models_temp.csv")
writexl::write_xlsx(best_models_temp, "data/best_models_temp.xlsx")


best_models_prec <- models_prec |> 
  group_by(species) |> 
  filter(term == "x") |> 
  dplyr::select(species, Model, AIC) |> 
  mutate(deltaAIC = akaike.weights(AIC)$deltaAIC, 
         w = akaike.weights(AIC)$weights) |> 
  filter(deltaAIC <= 4)

write_csv(best_models_prec, "data/best_models_prec.csv")
writexl::write_xlsx(best_models_prec, "data/best_models_prec.xlsx")
```


```{r}
doy_medio_sp <- df_doy_wmd |> 
  group_by(species) |> 
  summarise(doym = as.Date( mean(weigth_mean_date),origin = as.Date("2024-01-01")))

write_csv(doy_medio_sp, "data/doy_medio_sp.csv")
writexl::write_xlsx(doy_medio_sp, "data/doy_medio_sp.xlsx")
```


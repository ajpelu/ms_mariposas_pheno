---
title: "analysis peak"
author: "ajpelu"
date: "2023-06-01"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(vroom)
library(glue)
library(glmulti)
library(lme4)
library(broom)
library(broom.mixed)
library(kableExtra)
library(DT)
```


```{r, message=FALSE}
df_doy <- vroom::vroom(here::here("data/doy_peak_sps.csv"))
transectos <- vroom::vroom(here::here("data/transectos_metadata.csv"))
selected_sps <- vroom::vroom(here::here("data/selected_species.csv"))

climate_data <- vroom::vroom(here::here("data/transectos_climate.csv")) |> 
  filter(hydro_year !=2007) |> 
  rename(site_id = transectid, year = hydro_year)
```

## Prepare data 
```{r}
aux_df <- df_doy |> 
  filter(species %in% selected_sps$sp) |> 
  dplyr::select(species, year, doy, site_id) 

df_tmean <- aux_df |> 
  left_join(
    (climate_data |> filter(var == "tmed")))

df_prec <- aux_df |> 
  inner_join(
    (climate_data |> filter(var == "p")))
```


# Models

- For each species, we model the relationship between the flight's peak doy and the temperature (and precipitation) variables. 
- We built 36 models using a time-window approach. We calculated the mean temperatures (and cummulative precipitation) of 36 potential time-windows ranging from one to three months from October of the previous year to September of the current year.
- We used these potential timewindows to identify the period of the year with the highest temperature (or precipation) effect on the phenology of each species (the critical period). 
- For each time-window and species, we fitted the DOY using a GLMM with temperature (or precipation) as a predictor, site as a random effect and a Gaussian error distribution.
- For each species, we selected the best-fit model according to the AIC. 

## Temperature med 

```{r}
fit_glmm <- function(df, x) {
  glmm <- lme4::glmer(doy ~ x + (1 | site_id), 
                family = gaussian, 
                data = df)
  return(glmm)
}

sps <- selected_sps |> 
  filter(sp != "Polyommatus thersites") |> 
  pull(sp)


models_tmed<- data.frame()

# Tmed 
for (i in sps) { 
  df <- 
    df_doy |> 
    filter(species == i) |> 
    dplyr::select(species, year, doy, site_id) |> 
    left_join(climate_data |> filter(var == "tmed"))
  
  if (nrow(df) > 5) { 

  models <- df |> 
    dplyr::select(Jan:Dec_preJanFeb) |> 
    map(~fit_glmm(df, .x))
  
  # get AIC
  models_aic <- map(models, broom.mixed::glance) |> 
    bind_rows(.id = "Model") 
  
  # get R2 
  models_r <- map2_dfr(names(models), models, 
                       ~ data.frame(Model = .x, MuMIn::r.squaredGLMM(.y)))

  # get COEF
  models_coef <- map(models, ~broom.mixed::tidy(.x, 
                                 effects = c("fixed"), 
                                 conf.level = 0.95)) |> 
    bind_rows(.id = "Model") |> 
    mutate(p_value = round(2 * (1 - pnorm(abs(statistic))),4)) # add p.value of coef

  output_models <- models_coef |> 
    full_join(models_aic, multiple = "all") |>
    full_join(models_r, multiple = "all") |> 
    arrange(AIC) |> 
    mutate(species = i) |> 
    relocate(species)
  
  models_tmed <- rbind(models_tmed, output_models)
     
  }
}

```

#### How many species 
```{r}
length(unique(models_tmed$species))
```


```{r}
models_tmed |>
  mutate(across(c(estimate, std.error, statistic, sigma, logLik, AIC, BIC, REMLcrit), ~round(., digits = 2))) |> 
  mutate(across(c(R2m, R2c), ~round(., digits = 3))) |> 
  mutate(across(c(p_value), ~round(., digits = 4))) |> 
  DT::datatable()
```

```{r}
write_csv(models_tmed, "data/models_tmed.csv")
writexl::write_xlsx(models_tmed, "data/models_tmed.xlsx")
```


## Precip 
```{r}
fit_glmm <- function(df, x) {
  glmm <- lme4::glmer(doy ~ x + (1 | site_id), 
                family = gaussian, 
                data = df)
  return(glmm)
}

sps <- selected_sps |> 
  filter(sp != "Polyommatus thersites") |> 
  pull(sp)


models_prec <- data.frame()

# Tmed 
for (i in sps) { 
  df <- 
    df_doy |> 
    filter(species == i) |> 
    dplyr::select(species, year, doy, site_id) |> 
    left_join(climate_data |> filter(var == "p"))
  
  if (nrow(df) > 5) { 

  models <- df |> 
    dplyr::select(Jan:Dec_preJanFeb) |> 
    map(~fit_glmm(df, .x))
  
  # get AIC
  models_aic <- map(models, broom.mixed::glance) |> 
    bind_rows(.id = "Model") 
  
  # get R2 
  models_r <- map2_dfr(names(models), models, 
                       ~ data.frame(Model = .x, MuMIn::r.squaredGLMM(.y)))
  
  # get COEF
  models_coef <- map(models, ~broom.mixed::tidy(.x, 
                                 effects = c("fixed"), 
                                 conf.level = 0.95)) |> 
    bind_rows(.id = "Model") |> 
    mutate(p_value = round(2 * (1 - pnorm(abs(statistic))),4)) # add p.value of coef

  output_models <- models_coef |> 
    full_join(models_aic, multiple = "all") |> 
    full_join(models_r, multiple = "all") |> 
    arrange(AIC) |> 
    mutate(species = i) |> 
    relocate(species)
  
  models_prec <- rbind(models_prec, output_models)
     
  }
}
```

#### How many species 
```{r}
length(unique(models_tmed$species))
```


```{r}
models_prec |>
  mutate(across(c(estimate, std.error, statistic, sigma, logLik, AIC, BIC, REMLcrit), ~round(., digits = 2))) |> 
  mutate(across(c(R2m, R2c), ~round(., digits = 3))) |> 
  mutate(across(c(p_value), ~round(., digits = 4))) |> 
  DT::datatable()
```

```{r}
write_csv(models_prec, "data/models_prec.csv")
writexl::write_xlsx(models_prec, "data/models_prec.xlsx")
```








```{r, echo=FALSE, eval=FALSE}
best_models <- models_tmed |> 
  group_by(species) |> 
  filter(AIC == min(AIC)) |> 
  filter(term == "x") |> 
  dplyr::select(species, Model)


aux_df_tmed <- df_doy |> 
    dplyr::select(species, year, doy, site_id) |> 
    left_join(climate_data |> filter(var == "tmed"))

# i <- "Aglais urticae"

df_plots <- data.frame() 


modelize_sps <- best_models$species

for (i in modelize_sps) { 
  xterm <- best_models |> filter(species == i) |> pull(Model)
  
  out_df_plot <- aux_df_tmed |> filter(species == i) |> 
    dplyr::select(one_of("species", "year", "doy", "site_id", "var", xterm)) |> 
    mutate(x = xterm) |> 
    rename(values = starts_with(xterm))
  
  df_plots <- rbind(df_plots, out_df_plot)
  
  }




df |> 
  pivot_longer(-c(species:var)) |> 
  ggplot(aes(x=value, y=doy, colour=as.factor(site_id))) +
  geom_point() + 
  geom_smooth(method="lm", se=FALSE) + 
  facet_wrap(~name)
  


df |> 
  filter
  ggplot(aes(x=Feb, y=doy, colour=as.factor(site_id))) +
  geom_point() + geom_smooth(method="lm", se=FALSE)


```














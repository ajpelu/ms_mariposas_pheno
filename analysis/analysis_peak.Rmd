---
title: "analysis peak"
author: '[Antonio J. PÃ©rez-Luque](https://github.com/ajpelu) <a href="https://orcid.org/0000-0002-1747-0469" target="orcid.widget">
<img alt="ORCID logo" src="https://info.orcid.org/wp-content/uploads/2019/11/orcid_16x16.png" width="16" height="16" /></a>'
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 9, fig.height = 8
)
```

## Introduction

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(janitor) 
library(lubridate)
library(ggpubr)
library(Kendall)
library(trend)
library(DT)
library(vroom)
```


```{r, message=FALSE}
df_doy <- vroom::vroom(here::here("data/doy_peak_sps.csv"))
transectos <- vroom::vroom(here::here("data/transectos_metadata.csv"))
```

### Exploratory analysis 
First, we examine how the day of the year (doy) at which the maximum peak occurs varies throughout the years for each species and site. We create a custom function to generate a plot for each species faceted by site. All the pdfs generated are stored [here](https://github.com/ajpelu/ms_mariposas_pheno/tree/main/output/pheno_peak_doy). 

```{r}
plot_trend_doy_all <- function(df, sp){ 
  p <- df |> 
    filter(species == sp) |> 
    mutate(abb = fct_reorder(abb_elev, altitud)) |> 
    ggplot(aes(x=year, y=doy)) + 
    geom_point() + 
    facet_wrap(~abb) +
    geom_smooth(method = "lm", se = FALSE) +
    ggpubr::stat_cor(
      cor.coef.name = "R"
      # aes(label = after_stat(r.label))
      ) + 
    theme_bw() +
    theme(
    panel.grid= element_blank(), 
    strip.background = element_blank()) + 
    ylab("Day of year") + xlab("Year") + 
  labs(
    title = sp
  )  +
    scale_x_continuous(breaks = seq(min(df$year), max(df$year), by = 2)) 
  
  return(p)
  }

```


For instance, the following figure shows the data plot for *Aglais urticae*

```{r}
# Get species 
species <- unique(df_doy$species)

plot_trend_doy_all(df_doy, species[1])
```

```{r, eval=FALSE}
# Generate PDF files for each species using purrr::map()
map(species, ~{
  sp <- .
  p <- plot_trend_doy_all(df_doy, sp)
  pdf_file <- here::here("output/pheno_peak_doy/", paste0(sp, ".pdf"))
  ggsave(filename = pdf_file, plot = p, device = "pdf")
})
```


```{r, eval=FALSE, echo=FALSE}
plot_trend_doy_all_points <- function(df, sp, min_points){ 
  p <- df |> 
    ungroup() |> 
    filter(species == sp) |> 
    mutate(abb = fct_reorder(abb_elev, altitud)) |> 
    group_by(abb) |> 
    mutate(num_points = n()) |> 
    filter(num_points > min_points) |> 
    ggplot(aes(x=year, y=doy)) + 
    geom_point() + 
    facet_wrap(~abb) +
    geom_smooth(method = "lm", se = FALSE) +
    ggpubr::stat_cor(
      aes(label = after_stat(rr.label))
      ) + 
    theme_bw() +
    theme(
    panel.grid= element_blank(), 
    strip.background = element_blank()) + 
    ylab("Day of year") + xlab("Year") + 
  labs(
    title = sp
  )  +
    scale_x_continuous(breaks = seq(min(df$year), max(df$year), by = 2)) 
  
  return(p)
}

plot_trend_doy_all_points(df_doy, sp = "Aglais urticae", min_points = 4)

### error, falla cuando no hay min points 
map(species, ~{
  sp <- .
  p <- plot_trend_doy_all_points(df_doy, sp, min_points = 4)
  pdf_file <- here::here("output/pheno_peak_doy5/", paste0(sp, ".pdf"))
  ggsave(filename = pdf_file, plot = p, device = "pdf")
})
```

#### How many data? 

We would like to determine the number of sites where each species is present (`nsites`), and also compute the number of sites where the species has been recorded for at least 5 years (`nsites_higher4points`)

```{r}
npoints_sp_site <- df_doy |> 
    ungroup() |> 
    group_by(species, site_id, abb_elev) |> 
  summarise(num_points = n())

nsites_by_sps <- npoints_sp_site |> 
  group_by(species) |> 
  summarise(nsites = n())

nsites_by_sps_4points <- npoints_sp_site |>
  filter(num_points > 4) |> 
  group_by(species) |> 
  summarise(nsites_higher4points = n())


ns <- nsites_by_sps |> 
  full_join(nsites_by_sps_4points)

write_csv(ns, here::here("data/trends_peak_nsites.csv"))
```


```{r, echo=FALSE}
ns |> DT::datatable()
```

## Compute trends 

We analyze the temporal trend of the date at which the peak flight occurs (DOY). We calculate the trends using both the Mann-Kendall and Sen's slope methods, as well as linear methods, to assess how the DOY varies over time. We specifically focus on species where we have at least 5 data points, indicating that the species has been observed for a minimum of 5 years.

```{r}
compute_trend <- function(y, x) {
  # Compute Mann-Kendall test
  mk <- MannKendall(y)
  mk_tau <- mk$tau
  mk_pvalue <- mk$sl
  
  # Compute Sen's slope
  sen <- trend::sens.slope(y)
  sen_slope <- unname(sen$estimates)
  sen_stats <- unname(sen$statistic)
  sen_pvalue <- unname(sen$p.value)

  # Compute LM 
  model <- lm(y ~ x)
  lm_slope <- model$coefficients[2]
  lm_pvalue <- summary(model)$coefficients[2,4]
  lm_rsquared <- summary(model)$r.squared


  # Check for NULL values
  if (is.null(mk_tau)) mk_tau <- NA
  if (is.null(mk_pvalue)) mk_pvalue <- NA
  if (is.null(sen_slope)) sen_slope <- NA
  if (is.null(sen_stats)) sen_stats <- NA
  if (is.null(sen_pvalue)) sen_pvalue <- NA
  if (is.null(lm_slope)) lm_slope <- NA
  if (is.null(lm_pvalue)) lm_pvalue <- NA
  if (is.null(lm_rsquared)) lm_rsquared <- NA

  
  # Return results
  result <- data.frame(mk_tau = mk_tau, 
                       mk_pvalue = mk_pvalue, 
                       sen_slope = sen_slope, 
                       sen_stats = sen_stats, 
                       sen_pvalue = sen_pvalue, 
                       lm_slope = lm_slope, 
                       lm_pvalue = lm_pvalue, 
                       lm_rsquared = lm_rsquared)

  return(result)
}
```


```{r}
df_trends <- df_doy |> 
  ungroup() |> 
  group_by(species, site_id) |> 
  mutate(num_points = n()) |> 
  filter(num_points > 4)  |> 
  group_modify(~compute_trend(.x$doy, .x$year)) |> 
  inner_join(transectos)

write_csv(df_trends, here::here("data/trends_peak.csv"))
```


```{r, echo=FALSE}
df_trends |> 
  DT::datatable() |> 
  formatRound(
    columns = c("mk_tau", "mk_pvalue", "sen_slope", "sen_stats", "sen_pvalue", "lm_slope", "lm_pvalue", "lm_rsquared"),
    digits = c(3,4,3,2,4,3,4,3))
```

### Apply only to selected species 

Criteria for selected species: 
- Only univoltine species.
- Non-migratory.
- Exclude *Favonius quercus*
- They must present data from at least five years (which do not have to be consecutive)
- They don't have to appear in more than one location to calculate their phenology

```{r}
selected_sp <- vroom::vroom(here::here("data/selected_species.csv"),delim = ",") 

df_trends_selected <- df_trends |> 
  filter(species %in% selected_sp$sp)

```

We selected `r length(unique(df_trends_selected$species))` species. 

### Explore the trends



#### By elevation 

```{r}
ggscatter(df_trends_selected, 
          x = "altitud", y = "sen_slope", 
          add = "reg.line",
          add.params = list(color = "blue", fill = "lightgray"),
          conf.int = TRUE, 
          xlab = "Elevation (m)", 
          ylab = "Sen's Slope") +
   stat_cor(method = "pearson", label.y = -10, label.x = 2500)
```

```{r}
ggscatter(df_trends_selected, 
          x = "altitud", y = "mk_tau", 
          add = "reg.line",
          add.params = list(color = "blue", fill = "lightgray"),
          conf.int = TRUE, 
          xlab = "Elevation (m)", 
          ylab = "Mann-Kendall tau") +
   stat_cor(method = "pearson")
```

#### Explore by timing of the maximum 

- First we computed the doy mean for each specie 

```{r}
doy_mean <- df_doy |> 
  group_by(species) |> 
  summarise(mean = mean(doy, na.rm = TRUE),
            median = median(doy, na.rm = TRUE),
            sd = sd(doy, na.rm = TRUE),
            se = sd(doy, na.rm = TRUE) / sqrt(n()), 
            n = length(doy)) 

# df_doy |> 
#   group_by(species, site_id) |> 
#   summarise(mean = mean(doy, na.rm = TRUE),
#             median = median(doy, na.rm = TRUE),
#             sd = sd(doy, na.rm = TRUE),
#             se = sd(doy, na.rm = TRUE) / sqrt(n()), 
#             n = length(doy)) 
```

```{r, fig.height=12, eval=FALSE}
doy_mean |> 
  ggplot(aes(x=forcats::fct_reorder(species, mean), y = mean)) + geom_point() +
  geom_errorbar(aes(ymin = mean - se, ymax= mean + se)) + 
  coord_flip() +
  theme_bw() + 
  theme(
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank()
  ) + 
  xlab("") + ylab("DOY")
```


```{r, fig.height=14}
df_doy |> 
  ggplot(aes(x=reorder(species, doy, mean), y = doy)) + geom_point(size=.5, colour = "gray") +
  stat_summary(fun.data = mean_sd, geom = "pointrange") +
  coord_flip() + 
  theme_bw() + 
  theme(
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank()
  ) + 
  xlab("") + ylab("DOY") +
  scale_y_continuous(breaks = seq(0, max(df_doy$doy), by = 20)) 
```

Only for selected species 

```{r}
df_doy |> 
  filter(species %in% selected_sp$sp) |> 
  ggplot(aes(x=reorder(species, doy, mean), y = doy)) + geom_point(size=.5, colour = "gray") +
  stat_summary(fun.data = mean_sd, geom = "pointrange") +
  coord_flip() + 
  theme_bw() + 
  theme(
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank()
  ) + 
  xlab("") + ylab("DOY") +
  scale_y_continuous(breaks = seq(0, max(df_doy$doy), by = 20)) 
```

### Explore by doy_mean 

```{r}
df_trends_selected_mean <- df_trends_selected |> 
  group_by(species) |> 
  summarise(tau_mean = mean(mk_tau),
            tau_sd = sd(mk_tau, na.rm = TRUE),
            ta_se = sd(mk_tau, na.rm = TRUE) / sqrt(n()),
            sen_mean = mean(sen_slope),
            sen_sd = sd(sen_slope, na.rm = TRUE),
            sen_se = sd(sen_slope, na.rm = TRUE) / sqrt(n())
            )

d <- inner_join(
  df_trends_selected_mean, 
  (doy_mean |> 
  rename(doy_mean = mean, 
         doy_se = se, 
         doy_sd = sd))
)
```

```{r, eval=FALSE}
d |> 
  ggplot(aes(doy_mean, y = sen_mean)) +
  geom_point() + 
  theme_bw() +
  geom_smooth() +
  xlab("DOY") + 
  ylab("Sen's slope")
```



```{r, eval=FALSE}
d |> 
  ggplot(aes(doy_mean, y = mk_tau)) +
  geom_point() + 
  theme_bw() +
  geom_smooth() +
  xlab("DOY") + 
  ylab("Sen's slope")
```

```{r}
ggscatter(d, 
          x = "doy_mean", y = "tau_mean", 
          conf.int = TRUE, 
          xlab = "DOY", 
          ylab = "Mann-Kendall tau") +
   geom_smooth(method = "loess", formula = y ~ x) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") 
  
```

```{r}
ggscatter(d, 
          x = "doy_mean", y = "sen_mean", 
          conf.int = TRUE, 
          xlab = "DOY", 
          ylab = "Sen's Slope") +
     geom_smooth(method = "loess", formula = y ~ x) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") 
```







```{r, eval=FALSE, echo=FALSE}
  unite("abb", c("altitud","abreviatura"), remove = FALSE) |>
  mutate(abb = fct_reorder(abb, altitud)) |> 
  ggplot(aes(x=doy, y=nm, colour = as.factor(year))) + 
  geom_point() + 
  geom_path() + 
  facet_wrap(~abb) + 
  theme_bw() + 
  theme(
    panel.grid= element_blank(), 
    strip.background = element_blank()
  ) + ylab("") +
  labs(
    title = "Aglais urticae",
    colour = "Year"
  )






df_doy |> 
  filter(species == "Aglais urticae") |> 
  mutate(abb = fct_reorder(abb_elev, altitud)) |> 
  ggplot(aes(x=year, y=doy)) + 
  geom_point() + 
  facet_wrap(~abb) +
  geom_smooth(method = "lm", se = FALSE) +
  ggpubr::stat_cor(
    aes(label = after_stat(rr.label))  
  ) + theme_bw()

df_doy  |> 
  filter(species == "Aglais urticae") |> 
  unite("abb", c("altitud","abreviatura"), remove = FALSE) |>
  mutate(abb = fct_reorder(abreviatura, altitud)) |> 
  ggplot(aes(x=year, y=doy)) + 
  geom_point() + 
  facet_wrap(~abb_elev) +
  geom_smooth(method = "lm", se = FALSE) +
  ggpubr::stat_cor(
    aes(label = after_stat(rr.label))  
  ) +
  theme_bw()



d |> 
  unite("abb", c("altitud","abreviatura"), remove = FALSE) |>
  mutate(abb = fct_reorder(abb, altitud)) |> 
  ggplot(aes(x=doy, y=nm, colour = as.factor(year))) + 
  geom_point() + 
  geom_path() + 
  facet_wrap(~abb) + 
  theme_bw() + 
  theme(
    panel.grid= element_blank(), 
    strip.background = element_blank()
  ) + ylab("") +
  labs(
    title = "Aglais urticae",
    colour = "Year"
  )




peak_day %>%
  inner_join(transectos) %>%
  filter(species == "Aglais urticae") %>%
  unite("abb", c("altitud", "abreviatura"), remove = FALSE) %>%
  mutate(abb = fct_reorder(abreviatura, altitud)) %>%
  group_by(abb) %>%
  mutate(num_points = n()) %>%
  filter(num_points > 4) %>%
  ggplot(aes(x = year, y = doy)) +
  geom_point() +
  facet_wrap(~ abb) +
  geom_smooth(method = "lm", se = FALSE) +
  ggpubr::stat_cor(
    aes(label = after_stat(rr.label))
  ) +
  theme_bw()

library(ggplot2)
library(dplyr)
library(forcats)

peak_day %>%
  inner_join(transectos) %>%
  filter(species == "Aglais urticae") %>%
  unite("abb", c("altitud","abreviatura"), remove = FALSE) %>%
  mutate(abb = fct_reorder(abb, altitud)) %>%
  ggplot(aes(x = year, y = doy)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(
    ~ abb,
    labeller = labeller(
      abb = function(variable) {
        r_squared <- summary(lm(doy ~ year, data = subset(., abb == variable)))$adj.r.squared
        p_value <- summary(lm(doy ~ year, data = subset(., abb == variable)))$coefficients[8, 4]
        label <- paste(variable, "R-squared:", round(r_squared, 2), "p-value:", round(p_value, 2))
        label
      }
    )
  )

```


